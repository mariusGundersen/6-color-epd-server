<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilderamme</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <script src="https://unpkg.com/htmx.org@2.0.4"
    integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
    crossorigin="anonymous"></script>
  <script>
    function isBefore(el1, el2) {
      if (el2.parentNode !== el1.parentNode) return false;
      for (let cur = el1.previousElementSibling; cur; cur = cur.previousElementSibling) {
        if (cur === el2)
          return true;
      }
      return false;
    }

    let draggedElement;
    let initialSibling;
    function revertDraggedElement() {
      if (draggedElement.previousElementSibling === initialSibling) return
      initialSibling.insertAdjacentElement('afterend', draggedElement);
    }

    htmx.onLoad(function (content) {

      content.querySelectorAll('li[draggable=true]').forEach(elm => {
        elm.addEventListener('dragover', e => {
          e.dataTransfer.dropEffect = "move";
          e.preventDefault();
          if (e.currentTarget == draggedElement) return;
          e.currentTarget.insertAdjacentElement(isBefore(draggedElement, e.currentTarget) ? 'beforebegin' : 'afterend', draggedElement);
        }, false);

        elm.addEventListener('dragleave', e => {
          if (e.relatedTarget?.closest('[draggable=true]') === false) {
            revertDraggedElement()
          }
        }, false);

        let _elm;
        elm.addEventListener('pointerdown', e => {
          _elm = e.target;
        }, false);

        elm.addEventListener('dragstart', e => {
          if (!_elm.closest('.drag-handle')) {
            e.preventDefault();
            return;
          }
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", null); // Thanks to bqlou for their comment.
          draggedElement = e.currentTarget;
          initialSibling = e.currentTarget.previousElementSibling;
        }, false);

        elm.addEventListener('dragend', e => {
          if (e.dataTransfer.dropEffect === "none") {
            revertDraggedElement()
          }
        }, false);

        elm.addEventListener('drop', e => {
          console.log('drop', e.dataTransfer.dropEffect);
          e.preventDefault();
        }, false)

      });
    });
  </script>
</head>

<body>
  <div class="timeline">
    <ul hx-get="/api/photos/list" hx-swap="beforeend" hx-trigger="load">
      <li>
        <label>
          <input type="file" accept="image/*" />
          <span>Nytt bilde</span>
        </label>
      </li>
      <li class="htmx-indicator">
        <svg fill="#ffffff" viewBox="0 -0.5 25 25" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="m4.818 6.664s0 0-.001 0c-1.02 0-1.847-.827-1.847-1.847s.827-1.847 1.847-1.847 1.847.827 1.847 1.847c0 .51-.207.972-.541 1.306-.324.334-.776.541-1.277.541-.01 0-.019 0-.029 0zm-2.97 7.182s0 0-.001 0c-1.02 0-1.847-.827-1.847-1.847s.827-1.847 1.847-1.847 1.847.827 1.847 1.847c0 .51-.207.972-.541 1.306-.324.334-.776.541-1.278.541-.01 0-.021 0-.031 0h.002zm10.152-10.154s0 0-.001 0c-1.02 0-1.847-.827-1.847-1.847s.827-1.847 1.847-1.847 1.847.827 1.847 1.847c0 .51-.207.972-.541 1.306-.324.334-.776.541-1.277.541-.01 0-.019 0-.029 0zm-7.182 17.337s0 0-.001 0c-1.02 0-1.847-.827-1.847-1.847s.827-1.847 1.847-1.847 1.847.827 1.847 1.847c0 .51-.207.972-.541 1.306-.323.334-.775.541-1.276.541-.01 0-.021 0-.031 0zm14.364-13.904c-1.275 0-2.308-1.033-2.308-2.308s1.033-2.308 2.308-2.308c1.275 0 2.308 1.033 2.308 2.308s-1.033 2.308-2.308 2.308zm-7.182 16.875s0 0-.001 0c-1.02 0-1.847-.827-1.847-1.847s.827-1.847 1.847-1.847 1.847.827 1.847 1.847c0 .51-.207.972-.541 1.306-.324.334-.776.541-1.277.541-.01 0-.019 0-.029 0zm10.154-9.231c-.014 0-.031 0-.048 0-.75 0-1.428-.309-1.913-.807l-.001-.001c-.499-.503-.808-1.196-.808-1.961s.308-1.458.808-1.962c.486-.499 1.164-.808 1.914-.808h.05-.003.048c.75 0 1.427.309 1.913.807l.001.001c.499.503.808 1.196.808 1.961s-.308 1.458-.808 1.962c-.486.499-1.164.809-1.915.809-.016 0-.033 0-.049 0h.002zm-2.971 7.643c-.015 0-.032 0-.05 0-.878 0-1.671-.365-2.236-.951l-.001-.001c-.584-.584-.945-1.391-.945-2.283s.361-1.698.945-2.283c.567-.583 1.358-.945 2.234-.945h.054-.003.042c.877 0 1.67.362 2.237.944l.001.001c.588.582.952 1.39.952 2.283s-.364 1.7-.952 2.282c-.567.588-1.361.953-2.24.953-.014 0-.027 0-.04 0z"></path></g></svg>
      </li>
    </ul>
  </div>
  <dialog>
    <pan-zoom></pan-zoom>
    <form method="dialog">
      <button formmethod="dialog">CANCEL</button>
      <button type="submit">OK</button>
    </form>
  </dialog>
  <script type="module" src="/main.js"></script>
</body>

</html>
